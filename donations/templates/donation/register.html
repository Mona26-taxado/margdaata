<!DOCTYPE html>
{% load static %}
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Registration</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link
      rel="icon"
      href="{% static 'assets/img/margdata - copy.png' %}"
      type="image/x-icon"/>
    
    <style>
        body {
            background: linear-gradient(to right, #141E30, #243B55);
            font-family: 'Arial', sans-serif;
        }
        .container {
            max-width: 700px;
            margin-top: 30px;
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 12px;
            backdrop-filter: blur(10px);
            box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.3);
            color: #fff;
        }
        .form-control {
            border-radius: 8px;
            border: 2px solid transparent;
            transition: 0.3s;
        }
        .form-control:focus {
            border-color: #27ae60;
            box-shadow: none;
        }
        .form-label {
            font-weight: bold;
            color: #ffffff;
        }
        .btn-custom {
            background: #27ae60;
            color: white;
            font-weight: bold;
            padding: 10px;
            border-radius: 8px;
            transition: 0.3s;
        }
        .btn-custom:hover {
            background: #219150;
            transform: scale(1.05);
        }
        .file-input {
            border: 2px dashed #27ae60;
            padding: 10px;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            background: rgba(39, 174, 96, 0.2);
            transition: 0.3s;
        }
        .file-input:hover {
            background: rgba(39, 174, 96, 0.3);
        }
        .file-input input {
            display: none;
        }
        .fa-user-plus:before {
    content: "\f234";
    color: #00ff16;
}
        .qr-container {
            display: none;
            text-align: center;
            margin-top: 20px;
        }
        .input-group-text {
            background: #27ae60;
            color: white;
            border: none;
        }
        @media (max-width: 768px) {
            .container {
                max-width: 95%;
            }
        }
        span.razorpay-payment-button.svelte-ohbfj8 {
    justify-content: center;
    display: flex
;
    margin-top: 15px;
}
        .error-message {
            color: #ff6b6b;
            font-size: 0.9em;
            margin-top: 5px;
        }
        .input-group .btn-outline-secondary {
            border-color: #27ae60;
            color: #27ae60;
            background: transparent;
        }
        .input-group .btn-outline-secondary:hover {
            background: #27ae60;
            color: white;
            border-color: #27ae60;
        }
        .input-group .form-control {
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
        }
        .input-group .btn {
            border-top-left-radius: 0;
            border-bottom-left-radius: 0;
        }
    </style>
</head>
<body>

<div class="container">
    <h2 class="text-center"><i class="fa fa-user-plus"></i> Member Registration</h2>
    
    <!-- Payment section moved outside the form -->
    <div class="text-center mt-4 p-3" style="background: #ffffff; border-radius: 8px;">
        <h5 class="text-dark font-weight-bold">Scan & Pay</h5>
        <div>
            <img src="{% url 'upi_qr' %}" alt="Pay ₹50 to Margdata Trust UPI" style="max-width: 200px;" />
        </div>
        <button type="button" class="btn btn-primary" onclick="window.location.href='https://rzp.io/rzp/X0X5V9Id'">Pay ₹50</button>
        <p class="text-dark mt-2"><strong>UPI ID: margdatatrust@sbi</strong></p>
        <h6 class="text-danger font-weight-bold">(सर्वप्रथम कृपया 50₹ वार्षिक व्यवस्था सहयोग राशि ट्रस्ट को दान कर सहयोग करें।)
        </h6>
    </div>
    
    <form id="registrationForm" method="POST" enctype="multipart/form-data" action="{% url 'register_customer' %}">
        
        {% csrf_token %}
<!-- Bootstrap Alert for Error Messages -->
{% if messages %}
    <div class="alert alert-danger alert-dismissible fade show mt-3" role="alert">
        {% for message in messages %}
            {{ message }}
        {% endfor %}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
{% endif %}
{% load static %}

        <div class="row mt-3">
            <div class="col-md-6">
                <label class="form-label"><i class="fa fa-user"></i> Full Name *</label>
                {{ form.name }}
                {% if form.name.errors %}
                    <div class="error-message">{{ form.name.errors.0 }}</div>
                {% endif %}
            </div>
            <div class="col-md-6">
                <label class="form-label"><i class="fa fa-envelope"></i> Email * (for login)</label>
                {{ form.email }}
                {% if form.email.errors %}
                    <div class="error-message">{{ form.email.errors.0 }}</div>
                {% endif %}
            </div>
        </div>

        <div class="row mt-3">
            <div class="col-md-6">
                <label class="form-label"><i class="fa fa-phone"></i> Mobile *</label>
                {{ form.mobile }}
                {% if form.mobile.errors %}
                    <div class="error-message">{{ form.mobile.errors.0 }}</div>
                {% endif %}
            </div>
            <div class="col-md-6">
                <label class="form-label"><i class="fa fa-secure"></i> Password</label>
                <div class="input-group">
                    {{ form.password }}
                    <button class="btn btn-outline-secondary" type="button" id="togglePassword">
                        <i class="fa fa-eye" id="toggleIcon"></i>
                    </button>
                </div>
                {% if form.password.errors %}
                    <div class="error-message">{{ form.password.errors.0 }}</div>
                {% endif %}
            </div>
        </div>

        <div class="row mt-3">
            <div class="col-md-6">
                <label for="dob" class="form-label">Date of Birth:</label>
                {{ form.dob }}
                {% if form.dob.errors %}
                    <div class="error-message">{{ form.dob.errors.0 }}</div>
                {% endif %}
            </div>
            <div class="col-md-6">
                <label class="form-label"><i class="fa fa-venus-mars"></i> Gender *</label>
                {{ form.gender }}
                {% if form.gender.errors %}
                    <div class="error-message">{{ form.gender.errors.0 }}</div>
                {% endif %}
            </div>
        </div>

        <div class="row mt-3">
            <div class="col-md-6">
                <label class="form-label"><i class="fa fa-map-marker-alt"></i> Home District *</label>
                {{ form.home_district }}
                {% if form.home_district.errors %}
                    <div class="error-message">{{ form.home_district.errors.0 }}</div>
                {% endif %}
            </div>
            <div class="col-md-6">
                <label class="form-label"><i class="fa fa-home"></i> Home Address *</label>
                {{ form.home_address }}
                {% if form.home_address.errors %}
                    <div class="error-message">{{ form.home_address.errors.0 }}</div>
                {% endif %}
            </div>
        </div>

        <div class="row mt-3">
            <div class="col-md-6">
                <label class="form-label"><i class="fa fa-building"></i> Sector*</label>
                {{ form.department }}
                {% if form.department.errors %}
                    <div class="error-message">{{ form.department.errors.0 }}</div>
                {% endif %}
            </div>
            <div class="col-md-6">
                <label class="form-label"><i class="fa fa-suitcase"></i> Department *</label>
                {{ form.post }}
                {% if form.post.errors %}
                    <div class="error-message">{{ form.post.errors.0 }}</div>
                {% endif %}
            </div>
        </div>

        <div class="row mt-3">
            <div class="col-md-6">
                <label class="form-label"><i class="fa fa-user-friends"></i> Reference Name (Optional)</label>
                {{ form.reference_name }}
                {% if form.reference_name.errors %}
                    <div class="error-message">{{ form.reference_name.errors.0 }}</div>
                {% endif %}
            </div>
        </div>

  <div class="row mt-3">
  

<!-- Payment button outside the main form -->


<div class="mt-3">
    <input type="checkbox" id="terms" name="terms" required>
    <label for="terms" class="form-label">
        मैंने <strong>मार्गदाता ट्रस्ट</strong> के नियम और विनियम पढ़े हैं। मैं सभी नियमों और शर्तों से सहमत हूँ। 
        यदि मैं <strong>मार्गदाता ट्रस्ट</strong> के द्वारा बनाए गए नियमों के तहत नियमित रूप से योगदान नहीं करता हूँ 
        तो मेरा नामांकित व्यक्ति वित्तीय सहायता के लिए अपील नहीं करेगा।
        <br>
    </label>
</div>
<button type="submit" class="btn btn-custom w-100 mt-3"><i class="fa fa-paper-plane"></i> Register</button>
        
    </form>
    
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // CSRF token setup
    $.ajaxSetup({
        headers: { "X-CSRFToken": "{{ csrf_token }}" }
    });

    // Post options for each department
    const postOptions = {
        Government: [
            "Railway", "Health", "Panchayati Raj", "Irrigation department", "Jal Nigam", "Revenue", "Parivahan", "Bal Vikas Evam Pustahar", "Electric", "Bank", "Police", "Homegaurd", "Others"
        ],
        Private: [
            "Teacher", "Clerk", "Manager", "Peon", "Doctor", "Engineer", "Advocate", "Others"
        ]
    };
    
    // Department change handler
    document.addEventListener('DOMContentLoaded', function() {
        const departmentSelect = document.getElementById('id_department');
        if (departmentSelect) {
            departmentSelect.addEventListener('change', function() {
                const dept = this.value;
                const postSelect = document.getElementById('id_post');
                if (postSelect) {
                    postSelect.innerHTML = '<option value="" selected disabled>Select Post</option>';
                    if (dept && postOptions[dept]) {
                        postOptions[dept].forEach(function(opt) {
                            const option = document.createElement('option');
                            option.value = opt;
                            option.textContent = opt;
                            postSelect.appendChild(option);
                        });
                    }
                }
            });
        }

        // Password toggle functionality
        const togglePassword = document.getElementById('togglePassword');
        const passwordField = document.getElementById('id_password');
        const toggleIcon = document.getElementById('toggleIcon');
        
        if (togglePassword && passwordField) {
            togglePassword.addEventListener('click', function() {
                // Toggle password visibility
                const type = passwordField.getAttribute('type') === 'password' ? 'text' : 'password';
                passwordField.setAttribute('type', type);
                
                // Toggle eye icon
                if (type === 'text') {
                    toggleIcon.classList.remove('fa-eye');
                    toggleIcon.classList.add('fa-eye-slash');
                } else {
                    toggleIcon.classList.remove('fa-eye-slash');
                    toggleIcon.classList.add('fa-eye');
                }
            });
        }

        // Form submission handler
        const regForm = document.getElementById('registrationForm');
        const ajaxErrorDiv = document.getElementById('ajax-error-message');
        
        if (regForm) {
            regForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Basic validation
                let requiredFields = document.querySelectorAll("[required]");
                let isValid = true;

                requiredFields.forEach(field => {
                    if (!field.value.trim()) {
                        isValid = false;
                        field.style.border = "2px solid red";
                    } else {
                        field.style.border = "";
                    }
                });

                if (!isValid) {
                    alert("Error: All required fields must be filled.");
                    return;
                }

                // CSRF token helper
                function getCookie(name) {
                    let cookieValue = null;
                    if (document.cookie && document.cookie !== '') {
                        const cookies = document.cookie.split(';');
                        for (let i = 0; i < cookies.length; i++) {
                            const cookie = cookies[i].trim();
                            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                                break;
                            }
                        }
                    }
                    return cookieValue;
                }
                const csrftoken = getCookie('csrftoken');

                let form = this;
                let formData = new FormData(form);

                // Clear previous errors
                document.querySelectorAll('.error-message').forEach(el => el.innerHTML = '');
                if (ajaxErrorDiv) {
                    ajaxErrorDiv.classList.add('d-none');
                    ajaxErrorDiv.innerHTML = '';
                }

                // Show loading state
                const submitBtn = form.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                submitBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Registering...';
                submitBtn.disabled = true;

                fetch(form.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': csrftoken
                    }
                })
                .then(response => {
                    return response.json().catch(() => {
                        console.error('Non-JSON response:', response);
                        throw new Error('Server returned non-JSON response');
                    });
                })
                .then(data => {
                    console.log('AJAX response:', data);
                    if (data.success) {
                        window.location.href = data.redirect_url;
                    } else if (data.errors) {
                        // Show global errors
                        if (data.errors.__all__) {
                            if (ajaxErrorDiv) {
                                ajaxErrorDiv.classList.remove('d-none');
                                ajaxErrorDiv.innerHTML = data.errors.__all__.join('<br>');
                            }
                        }
                        // Show field errors
                        for (let field in data.errors) {
                            if (field === '__all__') continue;
                            let input = form.querySelector(`[name='${field}']`);
                            if (input) {
                                let errorDiv = input.parentElement.querySelector('.error-message');
                                if (errorDiv) {
                                    errorDiv.innerHTML = data.errors[field].join('<br>');
                                }
                            }
                        }
                    }
                })
                .catch(error => {
                    console.error('AJAX error:', error);
                    if (ajaxErrorDiv) {
                        ajaxErrorDiv.classList.remove('d-none');
                        ajaxErrorDiv.innerHTML = 'An error occurred. Please try again or check the console for details.';
                    }
                })
                .finally(() => {
                    // Restore button state
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                });
            });
        }
    });
</script>

<div id="ajax-error-message" class="alert alert-danger d-none" role="alert"></div>

</body>
</html>




